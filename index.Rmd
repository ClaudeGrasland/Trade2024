---
title: "La régionalisation du commerce mondial : mythe ou réalité ?"
subtitle: "Analyse à partir de la base CHELEM (1970-2020)"
author: "Claude Grasland"
date: "2 Janvier 2024"
output :
  html_document:
    toc: true
    toc_depth: 3
bibliography: references.bib
---

## Objectifs

Dans cette note exploratoire, nous proposons d'explorer la base *CHELEM* du CEPII à l'aide de la grille d'agrégation des pays du monde *VERTICALES* mise au point à partir des idées de Jean-Louis Guigou et des chercheurs de l'IPEMED. Le découpage proposé est organisé à deux niveaux, en 4 régions (VER1) elle-mêmes subdivisées en 12 sous-régions (VER2).

La base CHELEM, même si elle offre une résolution spatiale moindre que d'autres bases (94 états ou groupes d'états) permet de décomposer les échanges par type de produit ce qui permet de mettre à jour différentes formes de régionalisation en fonction des produits concernés.

```{r, echo=F, warning=F, message=F, error=F}
library(sf,quietly = T)
library(mapsf)
library(dplyr, quietly=T)
library(data.table, quietly = T)
library(ggplot2)
library(ggpubr)
library(plotly)
library(RColorBrewer)
library(visNetwork) 
theme_set(theme_pubr())
knitr::opts_chunk$set(echo = FALSE,comment = "",warning = FALSE,error = FALSE,message = FALSE)


```

## I. PRESENTATION DES DONNEES ET AGREGATS

L'idée de base est de proposer une lecture du Monde à partir de 4 régions "verticales" disposées du Nord au Sud. Trois de ces régions ont déjà été souvent analysées par les chercheurs de l'IPEMED. Mais nous avons jugé intéressant de rajouter une 4e région correspondant au "reste du Monde".

```{r load}
dt<-readRDS("data/MYCHELEM_V2.RDS")
dt$t<-as.numeric(dt$t)
```



### 94 unités d'observation

```{r}

chelem<-readRDS("data/World_Chelem.RDS") 

ns<-c("MLT","BLX","MOA","AFA","AFZ","SAF","AMA","AOZ","CAL","AOA","CAU","CEA","GOA")
agr<-chelem %>% filter(code %in% ns)


mypal<-rainbow(20)
mf_theme("agolalight")
mf_map(chelem, type="base", col="lightyellow")
mf_map(agr,
       type = "typo",
       var="name",
       leg_pos = "left",
       leg_title = "Groupes",
       add=T,
       pal=mypal
       )

mf_layout(title = "Agrégats de pays dans la base CHELEM",
          credits = "Source : CEPII, Base CHELEM",
          frame = T,
          arrow = F
          )

```

-   **Commentaire** : Afin d'assurer la continuité de la collecte des données commerciales sur une période très longue (1968- Présent), la base CHELEM a mise en place des agrégats de pays qui rendent plus facile la maintenance de la base mais réduisent la résolution géographique de l'analyse et éliminent de facto une partie des flux internationaux. Il s'agit souvent de groupes de petits pays jouant un faible rôle dans le commerce mondial(Amérique centrale, états insulaires du Pacifique, Cambodge et Laos, ...). Mais dans deux cas au moins les agrégats s'avèrent plus problématiques : (1) pour l'Afrique subsaharienne où seuls quelques pays sont identifiés individuellement (2) pour les états du Proche et Moyen Orient où l'un des agrégats mélange Iran, Irak et Koweit et un autre Syrie, Liban et Jordanie.

### 9 groupes de produits

La base CHELEM a réussi l'exploit de constituer une catégorisation des produits échangés sur plus de 50 ans malgré l'évolution des types de production et les changements de nomenclature. Nous adoptons ici une version simplifié de cette classification en 9 familles de produits correspondant à différents niveaux d'insertion dans les chaînes de valeur et la division internationale du travail (@grasland2010, @grataloup2014)

- (1) ENE : Energie
- (2) MIN : Mines, produits intermédiaires
- (3) AGR : Produits agricoles, alimentation
- (4) TEX : Textile, habillement
- (5) ELE : Electronique
- (6) EQU : Equipement, Machines
- (7) TRA : Transport
- (8) CHE : Chimie, Pharmacie
- (9) MIS : Divers



```{r}
Fkt<-dt[k!="TOT",.(Fkt=sum(Fijkt)),.(k,t)]
Ft<-dt[k!="TOT",.(Ft=sum(Fijkt)),.(t)]
tab<-left_join(Fkt,Ft) %>% mutate(pct=100*Fkt/Ft)
g<-ggplot(tab) + aes(x=t, y=pct,fill=k) +
               geom_bar(stat="identity") +
       scale_x_continuous("Année") +
       scale_y_continuous("% flux mondiaux") +
       ggtitle("Echanges commerciaux mondiaux en 9 groupes",subtitle = "Source : CEPII, Base CHELEM")
ggplotly(g)
```

- **Commentaires** : Le graphique montre que les 9 groupes de produits réalisent une partition relativement équilibrée des échanges mondiaux tout en permettant de suivre les tendances longues à la hausse (électronique, chimie), la stabilité (transport,textile )  ou à la baisse (agriculture) de la part de chaque produit en valeur. Les fluctuations les plus importantes concernent les produits énergétiques qui voient leur part osciller entre 8% et 24%  selon les années. La série de données s'arrêtant en 2020, on ne voit pas l'accroissement spectaculaire de leur part qui intervient à partir de 2022 en raison de la crise russo-ukrainienne. On ne voit pas non plus l'effet corrélatif du renchérissement des produits agricoles. 

### 3 régions verticales + 1 région résiduelle

```{r}
gui1<-readRDS("data/Chelem_Reg_1.RDS") %>% filter(GUI1 !="G0")
gui1$code<-paste(gui1$GUI1,gui1$GUI1_Name,sep=":")
mypal<-c("Blue","Red","Orange","Green")
mf_theme("agolalight")
mf_map(gui1,
       type = "typo",
       var="code",
       leg_pos = "left",
       leg_title = "Régions",
       pal=mypal,
       )
mf_layout(title = "Découpage vertical en 4 régions",
          credits = "Source : adapté de J.L. Guigou & al., IPEMED, 2023",
          frame = T,
          arrow = F
          )

```

-   **Commentaire** : Les trois premières régions reprennent le découpage proposé par J.L. Guigou et les chercheurs de l'IPEMED à une différence près : les pays pétroliers du Golfe persique n'ont pas été rattachés à la verticale Europe-Méditerranée-Afrique car leur commerce est clairement mondialisé et ne se rattache à aucune verticale.

Quelques rattachements non voulus ont par ailleurs été imposés par la structure de la base CHELEM du fait de l'existence d'agrégats de pays non séparables (e.g. rattachement de l'Afghanistan à l'ensemble Asie-Pacifique ou du Yemen à l'ensemble Europe-Méditerranée-Afriqe)

La quatrième région "reste du Monde" n'est pas a priori une zone d'intégration régionale mais elle doit être prise en compte pour compléter l'analyse et lui donner une dimension globale. Elle comporte des pays qui sont tiraillés entre plusieurs orientations régionales à l'instar de la Russie, L'Inde ou l'Arabie Saoudite.

```{r}
Fit<-dt[k=="TOT",.(Fit=sum(Fijkt)),.(reg1i,t)]
Ft<-dt[k=="TOT",.(Ft=sum(Fijkt)),.(t)]
tab<-left_join(Fit,Ft) %>% mutate(pct=100*Fit/Ft)
g<-ggplot(tab) + aes(x=t, y=pct,fill=reg1i) +
               geom_bar(stat="identity") +
       scale_x_continuous("Année") +
       scale_y_continuous("% flux mondiaux") +
       ggtitle("Part des exportations mondiales (y compris internes)",subtitle = "Source : CEPII, Base CHELEM")
ggplotly(g)

Fjt<-dt[k=="TOT",.(Fjt=sum(Fijkt)),.(reg1j,t)]
Ft<-dt[k=="TOT",.(Ft=sum(Fijkt)),.(t)]
tab<-left_join(Fjt,Ft) %>% mutate(pct=100*Fjt/Ft)
g<-ggplot(tab) + aes(x=t, y=pct,fill=reg1j) +
               geom_bar(stat="identity") +
       scale_x_continuous("Année") +
       scale_y_continuous("% flux mondiaux") +
       ggtitle("Part des importations mondiales (y compris internes)",subtitle = "Source : CEPII, Base CHELEM")
ggplotly(g)
```

- **Commentaire** : En apparence la région Europe-Méditerranée-Afrique semble jouer le rôle le plus important dans les importations comme dans les exportations mondiales, même si sa part diminue au fil du temps au profit de la région Asie-Pacifique. Toutefois **ce résultat est dans une large mesure une illusion** liée au fait que cette région est subdivisée en un très grand nombre de pays qui échangent avec leur voisins, à la différence de l'Amérique ou de l'Asie pacifique pour lesquels le trafic intérieur aux grands pays n'est pas visible. La vision des échanges serait à l'évidence très différente si on avait pris en compte les échanges entre les provinces chinoises ou les états fédérés des USA. 


### 12 sous-régions

```{r}

gui2<-readRDS("data/Chelem_Reg_2.RDS") %>% filter(GUI2 !="G01")
gui2$code<-paste(gui2$GUI2,gui2$GUI2_Name)


mypal<-c(rev(brewer.pal(5,"Blues")[1:3]),
         rev(brewer.pal(5, "Reds")[1:3]),
        rev(brewer.pal(5,"YlOrBr")[1:3]),
         rev(brewer.pal(5,"Greens")[1:3])

         )
#mypal<-rainbow(12)
mf_theme("agolalight")
mf_map(gui2,
       type = "typo",
       var="code",
       leg_pos = "left",
       leg_title = "Régions",
       pal=mypal,
       )

mf_layout(title = "Découpage vertical en 12 sous régions",
          credits = "Source : C. Grasland, 2024",
          frame = T,
          arrow = F
          )

```

-   **Commentaire :** Chacune des quatre régions a été découpée en 3 sous-régions en suivant à nouveau approximativement les propositions de J.L. Guigou et de l'IPEMED mais avec quelques adaptations. Nous avons notamment choisi de rattacher le Mexique à l'Amérique Centrale plutôt que l'Amérique du Nord dans la mesure où la période d'étude est longue (1968-2020) et ne correspond pas à l'existence permanente de l'ALENA. Nous avons par ailleurs maintenu l'ex-URSS dans une seule région (exception faite des pays baltes) afin de pouvoir suivre son évolution sur toute la période.

```{r}
Fit<-dt[k=="TOT" & reg2i!=reg2j,.(Fit=sum(Fijkt)),.(reg1i,t)]
Ft<-dt[k=="TOT"  & reg2i!=reg2j,.(Ft=sum(Fijkt)),.(t)]
tab<-left_join(Fit,Ft) %>% mutate(pct=100*Fit/Ft)
g<-ggplot(tab) + aes(x=t, y=pct,fill=reg1i) +
               geom_bar(stat="identity") +
       scale_x_continuous("Année") +
       scale_y_continuous("% flux mondiaux") +
       ggtitle("Part des exportations vers d'autres sous-régions",subtitle = "Source : CEPII, Base CHELEM")
ggplotly(g)

Fjt<-dt[k=="TOT" & reg2i!=reg2j,.(Fjt=sum(Fijkt)),.(reg1j,t)]
Ft<-dt[k=="TOT" & reg2i!=reg2j,.(Ft=sum(Fijkt)),.(t)]
tab<-left_join(Fjt,Ft) %>% mutate(pct=100*Fjt/Ft)
g<-ggplot(tab) + aes(x=t, y=pct,fill=reg1j) +
               geom_bar(stat="identity") +
       scale_x_continuous("Année") +
       scale_y_continuous("% flux mondiaux") +
       ggtitle("Part des importations depuis d'autres sous-régions",subtitle = "Source : CEPII, Base CHELEM")
ggplotly(g)
```

- **Commentaire** : En éliminant les échanges internes à chacune des sous-régions on obtient une mesure plus juste du rôle de chacune des quatre grandes régions dans le commerce mondial. La région Europe-Méditerranée-Afrique totalisait 40 à 45% des importations ou exportations dans les années 1970 contre 20 à 25% en 2020. La région Amériques conserve une part relativement stable d'environ 30% des importations au cours du temps  mais voit sa part des exportations diminuer de 30 à 20%. La région Asie Pacifique voit quant à elle sa part des eportations mondiales doubler, passant de 16 à 43%. La progression est également remarquable pour les importations qui passent de 18 à 33%. Quant à la région résiduelle "reste du monde" elle joue un rôle relativement mineur dans les importations tout au long de la période (10 à 15%) mais connaît des fluctuations forte dans sa part des exportations (8 à 22%) en raison des variations de prix des produits énergétiques. 




## II. ANALYSE MACROSCOPIQUE DE L'INTEGRATION REGIONALE

Dans cette première partie on procède à une synthèse rapide des échanges commerciaux entre les quatres grandes régions afin de déterminer la part du commerce interne à chacune de celles-ci, puisles variations de l'intégration régionale par produit et enfin par région.

### Tous produits confondus

```{r}
dt$intra<-as.factor(dt$reg1i==dt$reg1j)
levels(dt$intra)<-c("Inter", "Intra")

int<-dt[k=="TOT",.(Fijkt),.(t,intra)]
tab<-dcast(int,formula=t~intra,value.var="Fijkt",fun.aggregate = sum)

tab$intra_pct<-100*tab$Intra/(tab$Inter+tab$Intra)
tab$t<-as.numeric(tab$t)
g<-ggplot(tab, aes(x=t, y=intra_pct))+
       geom_line(col="red") +
       scale_x_continuous("Année") +
       scale_y_continuous("% flux intra-régionaux") +
       ggtitle("Intégration régionale : Tous produits",subtitle = "Source : CEPII, Base CHELEM") +

     geom_vline(xintercept = 1973, lty=2, col="blue")+
    geom_text(aes(x=1973, y=50, label="1973"),col="blue")+
     geom_vline(xintercept = 1981, lty=2, col="blue")+
    geom_text(aes(x=1981, y=50, label="1981"),col="blue")+
       geom_vline(xintercept = 1991, lty=2, col="blue")+
    geom_text(aes(x=1991, y=50, label="1991"),col="blue")+
       geom_vline(xintercept = 2001, lty=2,col="blue")+
    geom_text(aes(x=2001, y=50, label="2001"),col="blue")+
       geom_vline(xintercept = 2012, lty=2,col="blue")+
    geom_text(aes(x=2012, y=50, label="2012"),col="blue")
ggplotly(g)
```

-   **Commentaire :** La figure représente la part des flux commerciaux (tous produits confondus) qui ont pour origine et destination une même région (selon le découpage en quatre proposé précédemment). Le niveau d'intrégration intra-régionale demeure élevé tout au long de la période (entre 52% et 62%) mais présente des oscillations importantes qui semblent liées à des événements tels que les deux chocs pétroliers de 1973 et 1981, la fin de l'Union Soviétique (1991) ou l'entrée de la Chine à l'OMC (2001).

### Par famille de produits

```{r}
dt$intra<-as.factor(dt$reg1i==dt$reg1j)
levels(dt$intra)<-c("Inter", "Intra")
dt$k<-as.factor(dt$k)
levels(dt$k)<-c("Energie","Minerais","Agriculture","Textile","Electronique","Equipement","Transport","Chimie","Divers","Total")
int<-dt[k!="Total",.(Fijkt),.(t,intra,k)]
tab<-dcast(int,formula=t+k~intra,value.var="Fijkt",fun.aggregate = sum)

tab$intra_pct<-100*tab$Intra/(tab$Inter+tab$Intra)
tab$t<-as.numeric(tab$t)
g<-ggplot(tab, aes(x=t, y=intra_pct,col=k))+
       geom_line() +
       scale_x_continuous("Année") +
       scale_y_continuous("% flux intra-régionaux") +
       ggtitle("Intégration régionale : par produit",subtitle = "Source : CEPII, Base CHELEM")


ggplotly(g)
```

-   **Commentaire :** la décomposition des niveaux d'intégration régionale par famille de produits met en évidence des différences notables, notamment en ce qui concerne les produits énergétiques (gaz, pétrole, charbon, ...) qui voient leur niveau d'intégration diminuer très fortement entre les deux chocs prétroliers (35% en 1977) avant de remonter ensuite mais en restant à un niveau beaucoup plus faible que les autres produits. A contrario, les échanges de produits agricoles qui avaient un niveau d'intégration assez faible dans les années 1970 (environ 50%) connaissent une forte progression dans les années 1980 et deviennent les produits les plus intégrés régionalement avec la chimie et les minerais. Les produits textils connaissent une évolution inverse, en relation avec la concentration croissante de la production en Asie. Sans détailler les autres produits, on remarque que les vingt dernières années (2000-2020) montrent dans la quasi totalité des produits une baisse de l'intégration régionale, qu'il faut probablement mettre en relation avec la montée en puissance de la Chine.


### Par grande région

```{r}

myreg<-"G1:EurMedAfr"


Ft<-dt[reg1i != "G4:Reste du Monde",.(Ft=sum(Fijkt)),.(t, reg1i)]
Fit<-dt[reg1i==reg1j & reg1i != "G4:Reste du Monde",.(Fit=sum(Fijkt)),.(t, reg1i)]
tab<-left_join(Fit,Ft) %>% mutate(Fit_pct=100*Fit/Ft, region=reg1i)
g1<-ggplot(tab, aes(x=t, y=Fit_pct, col=region))+
       geom_line() +
       scale_x_continuous("Année", breaks=c(1960, 1970, 1980, 1990, 2000, 2010, 2020)) +
       scale_y_continuous("% export",lim=c(30,80),breaks=c(30, 40,50, 60, 70, 80)) +
       ggtitle("Intégration régionale des exportations",subtitle = "Source : CEPII-CHELEM")  
#theme(legend.position="bottom")
#ggsave("export.pdf", g1,width =8, height =6)
ggplotly(g1)


Ft<-dt[reg1j != "G4:Reste du Monde",.(Ft=sum(Fijkt)),.(t, reg1j)]
Fit<-dt[reg1i==reg1j & reg1j != "G4:Reste du Monde",.(Fit=sum(Fijkt)),.(t, reg1j)]
tab<-left_join(Fit,Ft) %>% mutate(Fit_pct=100*Fit/Ft, region=reg1j)
g2<-ggplot(tab, aes(x=t, y=Fit_pct, col=region))+
       geom_line() +
       scale_x_continuous("Année", breaks=c(1960, 1970, 1980, 1990, 2000, 2010, 2020)) +
       scale_y_continuous("% export",lim=c(30,80),breaks=c(30, 40,50, 60, 70, 80)) +
       ggtitle("Intégration régionale des importations",subtitle = "Source : CEPII-CHELEM")  
#theme(legend.position="bottom")
ggplotly(g2)
#g2

```

**Commentaires** : 

- L’analyse des exportations montre une forte intégration de la région Europe-Méditerranée Afrique tout au long de la période mais avec une tendance à la baisse dans les années 2000 et une stabilisation actuelle autour de 70% en 2020. Dans le cas des Amériques, l’intégration avait fortement augmenté dans les années 1990 avant de redescendre pour se stabiliser autour de 50% en 2020. La région Asie-Pacifique part d’une faible intégration dans les années 1970-1980 mais enregistre ensuitre des progrès continus pour atteindre presque 50% en 2020

- L’analyse des importations montre une évolution assez similaire à celle des exportations dans le cas de la région Europe-Méditerranée-Afrique pour aboutir également à un niveau de 70%. La situation est très différente dans les deux autres régions du Monde car on assiste à une baisse continue de l’intégration des Amériques (moins de 40% en 2020) et une hausse continue de celle-ci dans la région Asie-Pacifique (presque 60% en 2020).

Il faut toutefois noter que le maintien d’une forte intégration de la région Europe-Méditerranée-Afrique est en grande partie liée aux échanges internes à la seule Union Européenne et pas nécessairement aux échanges Nord-Sud entre l’Europe et la méditerranée ou l’Europe et l’Afrique. Il est donc nécessaire de regarder plus en détail les échanges de chaque pays ou agrégat de pays avec les trois grandes régions du Monde




### Europe - Méditerranée - Afrique

```{r}

myreg<-"G1:EurMedAfr"


Ft<-dt[reg1i==myreg,.(Ft=sum(Fijkt)),.(t)]
Fit<-dt[reg1i==myreg,.(Fit=sum(Fijkt)),.(t, reg1j)]
tab<-left_join(Fit,Ft) %>% mutate(Fit_pct=100*Fit/Ft, region=reg1j)
g1<-ggplot(tab, aes(x=t, y=Fit_pct, col=region))+
       geom_line() +
       scale_x_continuous("Année") +
       scale_y_log10("% export",lim=c(2,100),breaks=c(2,5,10,20,50,100)) +
       ggtitle(paste(myreg, ": Export"),subtitle = "Source : CEPII-CHELEM")  +
theme(legend.position="bottom")
ggplotly(g1)

Ft<-dt[reg1j==myreg,.(Ft=sum(Fijkt)),.(t)]
Fjt<-dt[reg1j==myreg,.(Fjt=sum(Fijkt)),.(t, reg1i)]
tab<-left_join(Fjt,Ft) %>% mutate(Fjt_pct=100*Fjt/Ft, region=reg1i)
g1<-ggplot(tab, aes(x=t, y=Fjt_pct, col=region))+
       geom_line() +
       scale_x_continuous("Année") +
       scale_y_log10("% export",lim=c(2,100),breaks=c(2,5,10,20,50,100)) +
       ggtitle(paste(myreg, ": import"),subtitle = "Source : CEPII-CHELEM")  +
theme(legend.position="bottom")
ggplotly(g1)


```

-   **Commentaire** : Même si elle connaît une légère baisse au cours des vingt dernières années, l'intégration de la région Europe-Méditerranée-Afrique demeure très élevée (66-78%) pour les importations comme pour les exportations. **Ce résultat est toutefois à prendre avec précaution** car il s'explique par la très forte fragmentation de l'Europe et les échanges internes à l'Union Européenne qui en résulte mécaniquement. Comme nous le verrons par le suite, la situation d'intégration est beaucoup moins claire lorsqu'on considère les échanges entre l'Europe et la Méditerranée ou l'Europe et l'Afrique subsaharienne.

### Amériques

```{r}
myreg<-"G2:Amériques"

Ft<-dt[reg1i==myreg,.(Ft=sum(Fijkt)),.(t)]
Fit<-dt[reg1i==myreg,.(Fit=sum(Fijkt)),.(t, reg1j)]
tab<-left_join(Fit,Ft) %>% mutate(Fit_pct=100*Fit/Ft, region=reg1j)
g1<-ggplot(tab, aes(x=t, y=Fit_pct, col=region))+
       geom_line() +
       scale_x_continuous("Année") +
       scale_y_log10("% export",lim=c(2,100),breaks=c(2,5,10,20,50,100)) +
       ggtitle(paste(myreg, ": Export"),subtitle = "Source : CEPII-CHELEM")  +
theme(legend.position="bottom")
ggplotly(g1)

Ft<-dt[reg1j==myreg,.(Ft=sum(Fijkt)),.(t)]
Fjt<-dt[reg1j==myreg,.(Fjt=sum(Fijkt)),.(t, reg1i)]
tab<-left_join(Fjt,Ft) %>% mutate(Fjt_pct=100*Fjt/Ft, region=reg1i)
g1<-ggplot(tab, aes(x=t, y=Fjt_pct, col=region))+
       geom_line() +
       scale_x_continuous("Année") +
       scale_y_log10("% export",lim=c(2,100),breaks=c(2,5,10,20,50,100)) +
       ggtitle(paste(myreg, ": import"),subtitle = "Source : CEPII-CHELEM")  +
theme(legend.position="bottom")
ggplotly(g1)
```

-   **Commentaire :** L'intégration des exportations demeure importante en 2020 (50%) bien qu'elle soit en baisse par rapport aux années 2000 où elle dépassait 60%. La montée en puissance des échanges avec l'Asie-Pacifique est très claire et s'accompagne corrélativement d'une baisse des échanges avec l'ensemble Europe-Méditerranée-Afrique. L'intégration est beaucoup plus faible en matière d'importation puisqu'en 2020 seuls 37% des produits sont importés de la région tandis qu'une part équivalente provient de la région Asie-Pacifique.

### Asie Pacifique

```{r}
myreg<-"G3:AsiePacifique"

Ft<-dt[reg1i==myreg,.(Ft=sum(Fijkt)),.(t)]
Fit<-dt[reg1i==myreg,.(Fit=sum(Fijkt)),.(t, reg1j)]
tab<-left_join(Fit,Ft) %>% mutate(Fit_pct=100*Fit/Ft, region=reg1j)
g1<-ggplot(tab, aes(x=t, y=Fit_pct, col=region))+
       geom_line() +
       scale_x_continuous("Année") +
       scale_y_log10("% export",lim=c(2,100),breaks=c(2,5,10,20,50,100)) +
       ggtitle(paste(myreg, ": Export"),subtitle = "Source : CEPII-CHELEM")  +
theme(legend.position="bottom")
ggplotly(g1)

Ft<-dt[reg1j==myreg,.(Ft=sum(Fijkt)),.(t)]
Fjt<-dt[reg1j==myreg,.(Fjt=sum(Fijkt)),.(t, reg1i)]
tab<-left_join(Fjt,Ft) %>% mutate(Fjt_pct=100*Fjt/Ft, region=reg1i)
g1<-ggplot(tab, aes(x=t, y=Fjt_pct, col=region))+
       geom_line() +
       scale_x_continuous("Année") +
       scale_y_log10("% export",lim=c(2,100),breaks=c(2,5,10,20,50,100)) +
       ggtitle(paste(myreg, ": import"),subtitle = "Source : CEPII-CHELEM")  +
theme(legend.position="bottom")
ggplotly(g1)
```

-   **Commentaire :** Cette partie du Monde est celle qui connaît la dynamique d'intégration la plus forte et la plus continue tout au long de la période. Dans le cas des exportations on passe de 40% dans les années 1970 à 50% en 2020. Dans celui des importations, de 35% en 1970 à près de 70% en 2020. Cela entraîne une diminution des échanges avec les autres régions du Monde, en particulier les Amériques et l'Europe-Méditerranée-Afrique.

### Reste du Monde

```{r}

myreg<-"G4:Reste du Monde"

Ft<-dt[reg1i==myreg,.(Ft=sum(Fijkt)),.(t)]
Fit<-dt[reg1i==myreg,.(Fit=sum(Fijkt)),.(t, reg1j)]
tab<-left_join(Fit,Ft) %>% mutate(Fit_pct=100*Fit/Ft, region=reg1j)
g1<-ggplot(tab, aes(x=t, y=Fit_pct, col=region))+
       geom_line() +
       scale_x_continuous("Année") +
       scale_y_log10("% export",lim=c(2,100),breaks=c(2,5,10,20,50,100)) +
       ggtitle(paste(myreg, ": Export"),subtitle = "Source : CEPII-CHELEM")  +
theme(legend.position="bottom")
ggplotly(g1)

Ft<-dt[reg1j==myreg,.(Ft=sum(Fijkt)),.(t)]
Fjt<-dt[reg1j==myreg,.(Fjt=sum(Fijkt)),.(t, reg1i)]
tab<-left_join(Fjt,Ft) %>% mutate(Fjt_pct=100*Fjt/Ft, region=reg1i)
g1<-ggplot(tab, aes(x=t, y=Fjt_pct, col=region))+
       geom_line() +
       scale_x_continuous("Année") +
       scale_y_log10("% export",lim=c(2,100),breaks=c(2,5,10,20,50,100)) +
       ggtitle(paste(myreg, ": import"),subtitle = "Source : CEPII-CHELEM")  +
theme(legend.position="bottom")
ggplotly(g1)
```

-   **Commentaire :** Cette partie du Monde est clairement la moins intégrée même si la part des échanges interne qui ne dépassait pas 5 à 10% dans les années 1970 atteint aujourd'hui plus de 20% pour les importations comme les exportations. Le changement le plus remarquable est ici la baisse continue de la part de l'ensemble Europe-Méditerranée-Afrique au profit de l'Asie-Pacifique. Il faut sans doute y voir une stratégie d'intégration asiatique (et non pas eurasiatique) qui a été amorcée par le Japon et la Corée dans les années 1980 puis pousuivie par la Chine avec les nouvelles routes de la soie. Ce mouvement étant par ailleurs conforté par les stratégies de diversification de leurs échanges de l'Inde et de la Russie.


### Echanges Nord-Nord, Nord-Sud et Sud-Sud

On peut imaginer une autre lecture centrée sur la division du Monde entre pays du Nord et pays du Sud. Mais cela impose de choisir une typologie qui est par définition évolutive au cours du temps. 

```{r}
dt$Nordi<-as.factor(dt$reg2i)
levels(dt$Nordi)<-c("Nord","Sud","Sud","Nord","Sud","Sud","Nord","Sud","Sud","Nord","Sud","Sud")
dt$Nordi<-as.character(dt$Nordi)
dt$Nordi[dt$i=="CHN"]<-"BRICS"
dt$Nordi[dt$i=="RUS"]<-"BRICS"
dt$Nordi[dt$i=="BRA"]<-"BRICS"
dt$Nordi[dt$i=="IND"]<-"BRICS"
dt$Nordi[dt$i=="SAF"]<-"BRICS"

dt$Nordj<-as.factor(dt$reg2j)
levels(dt$Nordj)<-c("Nord","Sud","Sud","Nord","Sud","Sud","Nord","Sud","Sud","Sud","Sud","Sud")
dt$Nordj<-as.character(dt$Nordj)
dt$Nordj[dt$j=="CHN"]<-"BRICS"
dt$Nordj[dt$j=="RUS"]<-"BRICS"
dt$Nordj[dt$j=="BRA"]<-"BRICS"
dt$Nordj[dt$j=="IND"]<-"BRICS"
dt$Nordj[dt$j=="SAF"]<-"BRICS"
dt$NS<-paste(dt$Nordi,dt$Nordj,sep="-")
dt$NS<-as.factor(dt$NS)
levels(dt$NS)
levels(dt$NS)<-c("4.BRICS-BRICS", "3.NORD-BRICS",  "5.BRICS-SUD" ,  "3.NORD-BRICS" , "1.NORD-NORD",   "2.NORD-SUD", "5.BRICS-SUD" ,  "2.NORD-SUD"  ,  "6.SUD-SUD")
dt$NS<-as.character(dt$NS)

Fit<-dt[k=="Total",.(Fit=sum(Fijkt)),.(NS,t)]
Ft<-dt[k=="Total",.(Ft=sum(Fijkt)),.(t)]

tab<-left_join(Fit,Ft) %>% mutate(pct=100*Fit/Ft)
g<-ggplot(tab) + aes(x=t, y=pct,fill=NS) +
               geom_bar(stat="identity") +
       scale_x_continuous("Année") +
       scale_y_continuous("% flux mondiaux") +
       ggtitle("Evolution des échanges entre Nord, Sud et BRICS",subtitle = "Source : CEPII, Base CHELEM")
ggplotly(g)


```

- **Commentaire** : La part des échanges entre pays du Nord (Europe, USA, Canada, Japon, Corée, Hong-Kong, Taiwan) est passée de 68% en 1988 à 40% en 2020. Les échanges entre pays du Sud (hors BRICS) est demeurée quant à elle très faible, passant de 3% en 1990 à un peu moins de 6% en 2020. Les échanges entre BRICS sont tout aussi faibles (2.5% en 2020). Ldes échanges Nord-Sud sont demeurés stables ou en légère diminution, passant de 25 à 20%. Le phénomène réellement nouveau est la montée des échanges entre les BRICS et les pays du Nord qui passent de 10% en 1990 à près de 20% en 2020 et surtout la montée des échanges entre les BRICS et les pays du Sud qui passent de 2% en 1990 à 13% en 2020. 


## III. CARTOGRAPHIE DES ZONES D'INTEGRATION REGIONALE 

Nous analysons ici la validité du découpage du monde en trois verticales en procédant à une évaluation de la part des échanges de chaque pays ou agrégat de pays vers les trois régions postulées par J.L. Guigou oui vers la région résiduelle "reste du monde". On considère trois situations possibles :

- **intégration régionale forte** : plus de 50% des échanges sont dirigés vers l'une des trois régions verticales. 
- **intégration régionale faible** : 40 à 50% des échanges sont dirigés vers l'une des trois régions verticales.
- **absence d'intégration régionale** : moins de 40% des échanges sont dirigés vers l'une des trois régions verticales. Cette situation peut résulter soit d'un partage d'influence entre les trois verticales, soit d'un rôle important de l'espace résiduel "reste du monde".

Nous présentons les cartes de régionalisation importations et exportations pour deux périodes décennales : en 1991-2000  et en  2011-2020

### Exportations

#### Exportations 1991-2000 

```{r}



Fij<-dt[k=="Total" & t>1990 & t <2001,.(Fij=sum(Fijkt)),.(i, reg1j)]
Fi<-dt[k=="Total" & t>1990 & t <2001,.(Fi=sum(Fijkt)),.(i)]
tab<-left_join(Fij,Fi) %>% mutate(pct=Fij/Fi)
tab2<-tab %>% group_by(i) %>% filter(pct==max(pct))
tab2$sup<-as.factor(tab2$pct>0.5)
levels(tab2$sup)<-c("40-50 %",">50%")
tab2$leg<-as.factor(paste(tab2$reg1j,tab2$sup))
levels(tab2$leg)[7:8]<-"Aucune région > 40%"
tab2$leg[tab2$pct<0.4]<-"Aucune région > 40%"
map<-readRDS("data/World_Chelem.RDS")

map<-merge(map, tab2, by.x="code", by.y="i",all.x=T,all.y=F)
map<-map %>% filter(code !="XXX")
mypal<-c("blue","lightblue","red","pink","orange","lightyellow","lightgreen")
mf_theme("agolalight")
mf_map(map, type="typo",
       var="leg",
       pal=mypal, 
       lwd=0.1)
mf_map(gui1, type="base",col=NA, add=T, lwd=1)
mf_layout(title = "Principale destination des exportations 1991-2000",
          credits = "Source : CEPII-Chelem - Auteur : C. Grasland, 2024",
          frame = T,
          arrow = F
          )






```

- **Commentaire de la situation en 1991-2000**
  + *La région Europe-Méditerranée-Afrique* est à son apogée et correspond à une zone de forte intégration des exportations(> 50%) de Vladivostok  à Capetown en passant par la Turquie et le Levant. Seuls font exception les satellites de la Russie (Belarus, Ukraine) et deux producteurs pétroliers africains tournés vers les USA (Nigéria et gGbon)
    + *La région Amériques*  est également bien intégrée, du Nord au Sud, même si c'est à un degré plus faible dans le cas du Brésil et du Chili. Seuls font exceptions les USA qui exportent vers l'ensemble du Monde et n'envoient que 39.7% de leurs exportation vers leur propre région contre 29.3% vers la région Asie-Pacifique et 27.5% vers la région Europe-Méditerranée-Afrique.
    + *La région Asie-Pacifique* connaît un début d'intégration mais avec une forte ouverture au reste du Monde. Le Japon exporte un peu plus de 40% vers sa région mais déjà 36% vers les Amériques contre un peu plus de 20% vers la région Europe-Méditerranée-Afrique. La Chine affiche un profil encore plus extraverti avec 37% de ses exportations vers sa région, 34% vers les Amériques et moins de 20% vers l'Europe-Méditerranée-Afrique. Il s'agit donc autant d'une intégration Pacifique que d'une intégration asiatique. 
    + *L'Inde* constitue un cas particulier de pays qui exporte aussi bien vers l'Europe-Méditerranée-Afrique (36%), l'Asie-Pacifique (25%), les Amériques (20%) et le reste du Monde (17%), ce dernier flux correspondant à des relations fortes avec la Russie et les pays issus de l'URSS.


#### Exportations 2011-2020 

```{r}

Fij<-dt[k=="Total" & t>2010,.(Fij=sum(Fijkt)),.(i, reg1j)]
Fi<-dt[k=="Total" & t>2010,.(Fi=sum(Fijkt)),.(i)]
tab<-left_join(Fij,Fi) %>% mutate(pct=Fij/Fi)
tab2<-tab %>% group_by(i) %>% filter(pct==max(pct))
tab2$sup<-as.factor(tab2$pct>0.5)
levels(tab2$sup)<-c("40-50 %",">50%")
tab2$leg<-as.factor(paste(tab2$reg1j,tab2$sup))
levels(tab2$leg)[7:8]<-"Aucune région > 40%"
tab2$leg[tab2$pct<0.4]<-"Aucune région > 40%"
map<-readRDS("data/World_Chelem.RDS")

map<-merge(map, tab2, by.x="code", by.y="i",all.x=T,all.y=F)
map<-map %>% filter(code !="XXX")
mypal<-c("blue","lightblue","red","pink","orange","lightyellow","lightgreen")
mf_theme("agolalight")
mf_map(map, type="typo",
       var="leg",
       pal=mypal, 
       lwd=0.1)
mf_map(gui1, type="base",col=NA, add=T, lwd=1)
mf_layout(title = "Principale destination des exportations 2011-2020",
          credits = "Source : CEPII-Chelem - Auteur : C. Grasland, 2024",
          frame = T,
          arrow = F
          )

```


- **Commentaires de la situation en 2011-2020: **
    + *La région Europe-Méditerranée-Afrique* demeure bien intégrée en matière d'exportations dans sa partie européenne et méditerranéenne puisque tous les pays y affichent des exportations destinées à plus de 50% vers la verticale, exception faite des pays du levant (Syrie, Liban, Israël, Jordanie). Mais la situation est désormais plus constrastée en Afrique subsaharienne où l'intégration est forte pour le Cameroun, la Côte d'Ivoire et le Kénya, mais faible pour le Ghana, le Nigéria, le Congo et l'Afrique australe. Quant aux autres pays ils dirigent leurs exportations en priorité vers la région Asie Pacifique même si l'intégration y demeure assez faible (40-50%) sauf dans le cas du Gabon.
    + *La région Amériques* demeur également bien intégrée en matière d'exportations, notamment dans sa partie septentrionale (Canada, Mexique, Amérique centrale, Colombie, Venezuela). Mais on retrouve comme en 1991-2000 une intégration plus faible des USA (qui exportent beaucoup en dehors de leur région) et de l'Argentine. Le Chili apparaît quant à lui davantage tourné vers l'Asie Pacifique tandis que le Brésil montre désormais une part égale d'exportations (34%) vers les Amériques  et l'Asie-Pacifique.
    
    + *La région Asie-Pacifique* polarise beaucoup plus fortement qu'en 1991-2000 son espace interne mais aussi l'ensemble des pays du Golfe Persique qui assurent son approvisionnement en hydrocarbure ainsi que le Gabon. Elle polarise faiblement une partie de l'Afrique subsaharienne et le Chili. La Chine apparait la moins intégrée du fait du déploiement de ses relations au niveau mondial plutôt qu'à l'intérieur de la seule région Asie-Pacifique. Elle envoie approximativement autant vers l'Asie-Pacifique (31%) , Les Amériques (30%)  et l'Europe-Méditerranée-Afrique (26%).
    + *L'Inde* quant à elle maintient une position de struct équilibre entre les quatre régions du Monde, envoyant de 20 à 30% vers chacune d'entre elles.
  
### Importations
  
#### Importations 1991-2000

```{r}

Fji<-dt[k=="Total" & t>1990 & t <2001,.(Fji=sum(Fijkt)),.(j, reg1i)]
Fj<-dt[k=="Total"& t>1990 & t <2001,.(Fj=sum(Fijkt)),.(j)]
tab<-inner_join(Fji,Fj) %>% mutate(pct=Fji/Fj)
tab2<-tab %>% group_by(j) %>% filter(pct==max(pct))
tab2$sup<-as.factor(tab2$pct>0.5)
levels(tab2$sup)<-c("40-50 %",">50%")
tab2$leg<-as.factor(paste(tab2$reg1i,tab2$sup))
levels(tab2$leg)[7:8]<-"Aucune région > 40%"
tab2$leg[tab2$pct<0.4]<-"Aucune région > 40%"
map<-readRDS("data/World_Chelem.RDS")
map<-merge(map, tab2, by.x="code", by.y="j",all.x=T,all.y=F)
mypal<-c("blue","lightblue","red","pink","orange","lightyellow","lightgreen")
mf_theme("agolalight")
mf_map(map, type="typo",var="leg",pal=mypal,alpha="pct", lwd=0.1)
mf_map(gui1, type="base",col=NA, add=T, lwd=1)
mf_layout(title = "Principale région d'origine des importations 1991-2000",
          credits = "Source : CEPII-Chelem - Auteur : C. Grasland, 2024",
          frame = T,
          arrow = F
          )



```


- **Commentaires :**
    + *La région Europe-Méditerranée-Afrique* en 1991-2010 est très fortement intégré pour les importations et étend même son influence dans ce domaine au Moyen-Orient et à l'Inde. Même les pays africains qui exportent davantage vers les Amériques (Nigéria, Gabon) réalisent la majorité de leurs importations depuis la région Europe-Méditerranée-Afrique. Il s'agit donc d'un moment historique privilégié où cette verticale aurait pu se mettre en place, ce que suggérait d'ailleurs de nombreux chercheurs et des experts dans des rapports de l'IPEMED ou du programme ESPON. 
    + *La région Amériques* montre également à cette date une forte intégration régionale de ses importations qui est en phase avec la signature des traités de libre échange du MERCOSUR (1991) ou de l'ALENA (1994). Les USA demeurent certes plus extravertis du fait de l'ouverture croissante du commerce transpacifique et ils échangent autant avec l'Asie Pacifique (37%) qu'avec leur propre région (36%).
    + *La région Asie-Pacifique* témoigne quant à elle d'une très forte intégration régionale de ses importations, nettement plus forte que celle des exportations qui sont davantage destinées au reste du Monde. L'ASEAN s'élargit à de nouveau pays et la Chine commence à devenir un rouage essentiel de l'intégration productive dans cette partie du Monde.
    + *L'Inde* demeure provisoirement intégrée faiblement à l'espace Europe-Méditerranée-Afrique (43%) mais elle a déjà des lines importants avec l'Asie-Pacifique (28%) et le reste du Monde (18%) en raison de ses importations d'énergie et de minerais depuis les pays du Golfe ou la Russie. 

#### Importations 2011-2020

```{r}

Fji<-dt[k=="Total" & t>2010,.(Fji=sum(Fijkt)),.(j, reg1i)]
Fj<-dt[k=="Total" & t>2010,.(Fj=sum(Fijkt)),.(j)]
tab<-inner_join(Fji,Fj) %>% mutate(pct=Fji/Fj)
tab2<-tab %>% group_by(j) %>% filter(pct==max(pct))
tab2$sup<-as.factor(tab2$pct>0.5)
levels(tab2$sup)<-c("40-50 %",">50%")
tab2$leg<-as.factor(paste(tab2$reg1i,tab2$sup))
levels(tab2$leg)[7:8]<-"Aucune région > 40%"
tab2$leg[tab2$pct<0.4]<-"Aucune région > 40%"
map<-readRDS("data/World_Chelem.RDS")
map<-merge(map, tab2, by.x="code", by.y="j",all.x=T,all.y=F)
mypal<-c("blue","lightblue","red","pink","orange","lightyellow","lightgreen")
mf_theme("agolalight")
mf_map(map, type="typo",var="leg",pal=mypal,alpha="pct", lwd=0.1)
mf_map(gui1, type="base",col=NA, add=T, lwd=1)
mf_layout(title = "Principale région d'origine des importations 2011-2020",
          credits = "Source : CEPII-Chelem - Auteur : C. Grasland, 2024",
          frame = T,
          arrow = F
          )



```

- **Commentaires :**
    + *La région Europe-Méditerranée-Afrique* présente en 2011-2020 en matière d'importation des caractéristiques assez proches de celles notées pour les exportations à cette même date. Mais avec un dégré d'intégration généralement plus faible, notamment en Turquie ou en Russie. Elle supplante toutefois de justesse l'Asie Pacifique dans l'ensemble des pays africains, exception faite de l'Egype, du Kenya et du Nigéria qui n'affichent pas d'intégration régionale dominante.
    + *La région Amériques* apparaît nettement plus intégrée mais avec deux exceptions de taille : le Brésil et les USA. Ces deux pays importent en effet moins de 40% de leurs échanges depuis cette région et sont en pratique partagés entre des influences multiples.
    + *La région Asie-Pacifique* apparaît désormais comme la plus fortement intégrée, y compris la Chine qui reçoit plus de 40% de ses importations de sa région d'appartenance. 
    + *L'Inde* mais aussi les *pays pétroliers du Golfe* et les pays d'*Asie Centrale* ne se rattachent à aucune des trois régions verticales. Cela peut s'expliquer par une diversité des origines de leurs importations (Inde, Golfe) mais aussi par une influence toujours importante de la Russie dans son voisinage proche. Et peut-être aussi par une intégration, même si elle demeure faible de cette région résiduelle. 
    
    

  
    
    
## IV. RESEAUX DE RELATIONS PREFERENTIELLES ENTRE SOUS-REGIONS

Nous procédons maintenant à une analyse plus détaillée des relations entre les 12 sous-régions afin de vérifier si les liens observés au niveau macroscopiques sont confirmés au niveau infra-régional. Pour cela, nous allons confronter les flux observés entre pays à ceux qui seraient obtenus dans l'hypothèse d'un modèle aléatoire d'indifférence à la distance.

### Flux Totaux 1971-1980

```{r}

t1<-1971
t2<-1980
kk<-"Total"
test<-dt %>% filter(t>=t1,t<=t2,k==kk) %>% 
              group_by(reg2i,reg2j) %>%
              summarise(Fij=  sum(Fijkt),
                        Eij = sum(Eijkt))%>%
              select(i=reg2i, j=reg2j, Fij, Eij)

              

nodesi<-test %>% group_by(i) %>% summarise(Fi=sum(Fij)) %>% 
                mutate(label=i) %>%
                select(label,Fi)
nodesj<-test %>% group_by(j) %>% summarise(Fj=sum(Fij)) %>% 
  mutate(label=j) %>%
  select(label,Fj)
nodes<-left_join(nodesi,nodesj)
nodes$VOL<-nodes$Fi+nodes$Fj
nodes$id<-rank(nodes$label)
nodes$value<-sqrt(100*nodes$VOL/max(nodes$VOL))
nodes<-nodes %>% arrange(label)
nodes$color.background<-c(rep("lightblue",3),  rep("pink",3),rep("lightyellow",3),rep("lightgreen",3))
nodes$color.border<-"black"
nodesi<-nodes[,c("id","label")]
names(nodesi)<-c("from","i")
edges<-test %>% left_join(nodesi)
nodesj<-nodes[,c("id","label")]
names(nodesj)<-c("to","j")
edges<-edges %>% left_join(nodesj)
edges$width=sqrt(100*edges$Fij/max(edges$Fij))
edges$arrows<-"top"

edges2<-edges %>% filter(Fij>Eij)
visNetwork(nodes, edges2, height = "500px", width = "100%",main = "Echanges préférentiels entre sous-régions du Monde", submain = "Tous produits - 1971-1980") 
```

-   **Commentaire** : Au lendemain des indépendances des pays africains, l'Europe domine largement le commerce mondial et polarise de façon préférentielle les échanges commercieux avec les pays d'Afrique et de Méditerranée. Elle intégère également l'URSS dans sa zone d'échange préféentielle. L'Amérique du Nord constitue le second pôle des échanges commerciaux et noue des échanges préférentiels avec l'Asie pacifique mais aussi le proche et Moyen orient pour son alimentation en hydrocarbure. un début d'intégration apparaît en Asie-Pacifique.

### Flux Totaux 1981-1990

```{r}

t1<-1981
t2<-1990
kk<-"Total"
test<-dt %>% filter(t>=t1,t<=t2,k==kk) %>% 
              group_by(reg2i,reg2j) %>%
              summarise(Fij=  sum(Fijkt),
                        Eij = sum(Eijkt))%>%
              select(i=reg2i, j=reg2j, Fij, Eij)

              

nodesi<-test %>% group_by(i) %>% summarise(Fi=sum(Fij)) %>% 
                mutate(label=i) %>%
                select(label,Fi)
nodesj<-test %>% group_by(j) %>% summarise(Fj=sum(Fij)) %>% 
  mutate(label=j) %>%
  select(label,Fj)
nodes<-left_join(nodesi,nodesj)
nodes$VOL<-nodes$Fi+nodes$Fj
nodes$id<-rank(nodes$label)
nodes$value<-sqrt(100*nodes$VOL/max(nodes$VOL))
nodes<-nodes %>% arrange(label)
nodes$color.background<-c(rep("lightblue",3),  rep("pink",3),rep("lightyellow",3),rep("lightgreen",3))
nodes$color.border<-"black"
nodesi<-nodes[,c("id","label")]
names(nodesi)<-c("from","i")
edges<-test %>% left_join(nodesi)
nodesj<-nodes[,c("id","label")]
names(nodesj)<-c("to","j")
edges<-edges %>% left_join(nodesj)
edges$width=sqrt(100*edges$Fij/max(edges$Fij))
edges$arrows<-"top"

edges2<-edges %>% filter(Fij>Eij)
visNetwork(nodes, edges2, height = "500px", width = "100%",main = "Echanges préférentiels entre sous-régions du Monde", submain = "Tous produits - 1981-1990") 
```

-   **Commentaire** : Dans la décennie qui précède la chute de l'Union soviétique, les échanges préférentiels de l'Europe se renforcent avec l'URSS mais aussi les pays du Golfe Persique. Ils demeurent important avec la Méditerranée mais commencent à s'affaiblir avec l'Afrique ou d'autres acteurs régionaux d'Asie (Japon) et d'Amérique (USA) développent désormais à leur tour des relations préférentiels. Dans le même temps, l'intégration entre les dxeux rives du Pacifique se renforce grâce à la conteneurisation et la diminution des coûts de transports.

### Flux Totaux 1991-2000

```{r}

t1<-1991
t2<-2000
kk<-"Total"
test<-dt %>% filter(t>=t1,t<=t2,k==kk) %>% 
              group_by(reg2i,reg2j) %>%
              summarise(Fij=  sum(Fijkt),
                        Eij = sum(Eijkt))%>%
              select(i=reg2i, j=reg2j, Fij, Eij)

              

nodesi<-test %>% group_by(i) %>% summarise(Fi=sum(Fij)) %>% 
                mutate(label=i) %>%
                select(label,Fi)
nodesj<-test %>% group_by(j) %>% summarise(Fj=sum(Fij)) %>% 
  mutate(label=j) %>%
  select(label,Fj)
nodes<-left_join(nodesi,nodesj)
nodes$VOL<-nodes$Fi+nodes$Fj
nodes$id<-rank(nodes$label)
nodes$value<-sqrt(100*nodes$VOL/max(nodes$VOL))
nodes<-nodes %>% arrange(label)
nodes$color.background<-c(rep("lightblue",3),  rep("pink",3),rep("lightyellow",3),rep("lightgreen",3))
nodes$color.border<-"black"
nodesi<-nodes[,c("id","label")]
names(nodesi)<-c("from","i")
edges<-test %>% left_join(nodesi)
nodesj<-nodes[,c("id","label")]
names(nodesj)<-c("to","j")
edges<-edges %>% left_join(nodesj)
edges$width=sqrt(100*edges$Fij/max(edges$Fij))
edges$arrows<-"top"

edges2<-edges %>% filter(Fij>Eij)
visNetwork(nodes, edges2, height = "500px", width = "100%",main = "Echanges préférentiels entre sous-régions du Monde", submain = "Tous produits - 1991-2000") 
```

-   **Commentaire** : Avec la supposée "fin de l'histoire" et la domination sans partage de l'hyperpuissance américaine, le commerce mondial prend une forme triadique presque parfaite. C'est sans doute le moment de l'histoire où les trois "verticales" apparaissent de la façon la plus claire. A une nuance près qui est le fait que l'Afrique subsaharienne demeure de plus en plus une zone aux influences multiples tandis que la Russie et les pays de l'ex union soviétique accroissent de plus en plus leurs échanges préférentiels avec l'Europe. L'Asie du Sud et le Golfe Persique quant à eux sont en situation intermédiaire mais nouent des liens entre eux, ainsi qu'avec les pays d'Afrique et de Méditerranée.

### Flux Totaux 2001-2010

```{r}

t1<-2001
t2<-2010
kk<-"Total"
test<-dt %>% filter(t>=t1,t<=t2,k==kk) %>% 
              group_by(reg2i,reg2j) %>%
              summarise(Fij=  sum(Fijkt),
                        Eij = sum(Eijkt))%>%
              select(i=reg2i, j=reg2j, Fij, Eij)

              

nodesi<-test %>% group_by(i) %>% summarise(Fi=sum(Fij)) %>% 
                mutate(label=i) %>%
                select(label,Fi)
nodesj<-test %>% group_by(j) %>% summarise(Fj=sum(Fij)) %>% 
  mutate(label=j) %>%
  select(label,Fj)
nodes<-left_join(nodesi,nodesj)
nodes$VOL<-nodes$Fi+nodes$Fj
nodes$id<-rank(nodes$label)
nodes$value<-sqrt(100*nodes$VOL/max(nodes$VOL))
nodes<-nodes %>% arrange(label)
nodes$color.background<-c(rep("lightblue",3),  rep("pink",3),rep("lightyellow",3),rep("lightgreen",3))
nodes$color.border<-"black"
nodesi<-nodes[,c("id","label")]
names(nodesi)<-c("from","i")
edges<-test %>% left_join(nodesi)
nodesj<-nodes[,c("id","label")]
names(nodesj)<-c("to","j")
edges<-edges %>% left_join(nodesj)
edges$width=sqrt(100*edges$Fij/max(edges$Fij))
edges$arrows<-"top"

edges2<-edges %>% filter(Fij>Eij)
visNetwork(nodes, edges2, height = "500px", width = "100%",main = "Echanges préférentiels entre sous-régions du Monde", submain = "Tous produits - 2001-2010") 
```

**- Commentaire:** La montée en puissance de la Chine accentue la polarisation du Monde entre trois régions et s'accompagne d'un éloignement de plus important de l'Afrique par rapport à l'Europe. L'Asie du Sud et les pays du Golfe basculent dans la zone d'échange préférentiels de l'Asie. Les Amériques maintiennent des échanges préférentiels mais subissent l'influence croissante et asymétrique de l'Asie pacifique qui exporte vers eux mais n'importe guère. Le déficit commercial des USA par rapport à la Chine se creuse de plus en plus.

### Flux totaux - 2011-2020

```{r}

t1<-2011
t2<-2020
kk<-"Total"
test<-dt %>% filter(t>=t1,t<=t2,k==kk) %>% 
              group_by(reg2i,reg2j) %>%
              summarise(Fij=  sum(Fijkt),
                        Eij = sum(Eijkt))%>%
              select(i=reg2i, j=reg2j, Fij, Eij)

              

nodesi<-test %>% group_by(i) %>% summarise(Fi=sum(Fij)) %>% 
                mutate(label=i) %>%
                select(label,Fi)
nodesj<-test %>% group_by(j) %>% summarise(Fj=sum(Fij)) %>% 
  mutate(label=j) %>%
  select(label,Fj)
nodes<-left_join(nodesi,nodesj)
nodes$VOL<-nodes$Fi+nodes$Fj
nodes$id<-rank(nodes$label)
nodes$value<-sqrt(100*nodes$VOL/max(nodes$VOL))
nodes<-nodes %>% arrange(label)
nodes$color.background<-c(rep("lightblue",3),  rep("pink",3),rep("lightyellow",3),rep("lightgreen",3))
nodes$color.border<-"black"
nodesi<-nodes[,c("id","label")]
names(nodesi)<-c("from","i")
edges<-test %>% left_join(nodesi)
nodesj<-nodes[,c("id","label")]
names(nodesj)<-c("to","j")
edges<-edges %>% left_join(nodesj)
edges$width=sqrt(100*edges$Fij/max(edges$Fij))
edges$arrows<-"top"

edges2<-edges %>% filter(Fij>Eij)
visNetwork(nodes, edges2, height = "500px", width = "100%",main = "Echanges préférentiels entre sous-régions du Monde", submain = "Tous produits - 2011-2020") 
```

**- Commentaire:** L'Asie de l'Est constitue désormais l'acteur majeur du commerce mondial et inclue dans sa zone d'échanges préfrentiels non seulement l'Asie du Sud et les pays du Golfe mais aussi l'Afrique subsaharienne et peut-être l'Amérique du Sud. Les relations préférentielles de l'Europe se limitent à elle-même ainsi que ses voisins les plus proches à l'Est et au Sud. Même chose pour les Amériques où l'intégration concerne désormais surtout la partie septentrionale et centrale.

### Energie - 2011-2020

```{r}

t1<-2011
t2<-2020
kk<-"Energie"
test<-dt %>% filter(t>=t1,t<=t2,k==kk) %>% 
              group_by(reg2i,reg2j) %>%
              summarise(Fij=  sum(Fijkt),
                        Eij = sum(Eijkt))%>%
              select(i=reg2i, j=reg2j, Fij, Eij)

              

nodesi<-test %>% group_by(i) %>% summarise(Fi=sum(Fij)) %>% 
                mutate(label=i) %>%
                select(label,Fi)
nodesj<-test %>% group_by(j) %>% summarise(Fj=sum(Fij)) %>% 
  mutate(label=j) %>%
  select(label,Fj)
nodes<-left_join(nodesi,nodesj)
nodes$VOL<-nodes$Fi+nodes$Fj
nodes$id<-rank(nodes$label)
nodes$value<-sqrt(100*nodes$VOL/max(nodes$VOL))
nodes<-nodes %>% arrange(label)
nodes$color.background<-c(rep("lightblue",3),  rep("pink",3),rep("lightyellow",3),rep("lightgreen",3))
nodes$color.border<-"black"
nodesi<-nodes[,c("id","label")]
names(nodesi)<-c("from","i")
edges<-test %>% left_join(nodesi)
nodesj<-nodes[,c("id","label")]
names(nodesj)<-c("to","j")
edges<-edges %>% left_join(nodesj)
edges$width=sqrt(100*edges$Fij/max(edges$Fij))
edges$arrows<-"top"

edges2<-edges %>% filter(Fij>Eij)
visNetwork(nodes, edges2, height = "500px", width = "100%",main = "Echanges préférentiels entre sous-régions du Monde", submain = "Produits énergétiques - 2011-2020") 
```


## ANNEX : MATHEMATICAL MODELS OF REGIONALIZATION

### Objectives


This working paper propose to discuss the theoretical problem of regionalisation of **a world (in abstract sense) ** through the empirical example of **The World (where we live)** described by trade flows over a long period of time and for different types of products.  

We will use for that purpose the CHELEM database produced by the CEPII which offers an exceptional coverage of trade flows over a period of 50 years from 1967 to present (2020). The most detailed version of this database describes the exchange between  94 x 94  territorial units (states or group of states) for 72 types of goods over a period of 54 years which means a 4-dimension object (hypercube) of size $94 \times 93 \times 72 \times 54 = 33988896$ cells. 

For our experiment, we will use a reduction of the database based on 12 territorial units described by 9 groups of goods for 5 periods of 10 years each. The hypercube used in our experiment will be therefore limited to a size of  $12 \times 11 \times 9 \times 5 = 5940$ cells. This can appear rather limited but - as we will demonstrate - the complexity of such an object is yet very high and it appears better to establish the theoretical foundation of the research of such an object before to adress larger databases where computational problem will grow exponentially. 

Our overarching question can now be formulated in the following way : 

- Let $W$ be **a world** divided in $1\dots i\dots  n$ territorial units.
- Let $F$ **a relation** defined on $W \times W$ which assign a value to each couple of units of the world (excluding only internal relations).
- Let $X$ **a typology of relations** in $1\dots k\dots  p$  types of relation using the same unit of mesurement.
- Let $T$ **a partition of time** in periods $1\dots t\dots  q$ where the relations are measured
- Let $H = F_{ijkt}$ the hypercube which measure of relation between territorial units $i$ and $j$ for the relation $k$ during time period $t$

- **Problem 1** : What are the partitions $P_i$ (for origins), $P_j$ (for destination), $P_k$ (for typology) and $P_t$ (for time period) that allows to reduce the size of the initial hypercube $H$ to a smaller one $H'$ without losing too much information. 
- **Problem 2** : can we identify homogeneous subparts of $H$ that are not necessarily based on orthogonal divisions of the hypercube. 
- **Problem 3**: can we identify trajectories of regionalisation $P_i(t)$,  $P_j(j)$  or trajectories of typology $P_k(t)$ that descibe the evolution of optimal partitions through time . 




```{r, echo=F, warning=F, message=F, error=F}
library(sf,quietly = T)
library(mapsf)
library(dplyr, quietly=T)
library(data.table, quietly = T)
library(ggplot2)
library(ggpubr)
library(plotly)
library(RColorBrewer)
library(visNetwork) 
library(knitr)
library(car)
library(pheatmap)
theme_set(theme_pubr())
knitr::opts_chunk$set(echo = FALSE,comment = "",warning = FALSE,error = FALSE,message = FALSE)


```

### I. EXPERIMENTAL DATABASE


```{r reload}
dt<-readRDS("data/MYCHELEM_V2.RDS")
dt$t<-as.numeric(dt$t)
```


#### The 94 terrtorial units of CHELEM

The original version of the CHELEM database is made of 94 territorial units. A majority of this territorial units correspond to states but some of them are made of aggregates of states for which it was difficult to separate trade flows or to collect them. The map below indicates what are the territorial units that do not fit with international division of the world in states. 

```{r}

chelem<-readRDS("data/World_Chelem.RDS") 

ns<-c("MLT","BLX","MOA","AFA","AFZ","SAF","AMA","AOZ","CAL","AOA","CAU","CEA","GOA")
agr<-chelem %>% filter(code %in% ns)


mypal<-rainbow(20)
mf_theme("agolalight")
mf_map(chelem, type="base", col="lightyellow")
mf_map(agr,
       type = "typo",
       var="name",
       leg_pos = "left",
       leg_title = "Groupes",
       add=T,
       pal=mypal
       )

mf_layout(title = "Agrégats de pays dans la base CHELEM",
          credits = "Source : CEPII, Base CHELEM",
          frame = T,
          arrow = F
          )

```

The aggregates of states are generally based on groups of small states (like in central America or Oceania) but it can also be the case for larger goups of states playing an important role in trade like in the case of the aggregate between Irag, Iran and Koweit. The aggregation is also very large in the case of subsaharan Africa where only few states are identified and the other mixed in large area, not necessarily contiguous. At the same time, Europe is fully disaggregated in isolated states, except in the case of Malta and Cyprus, which will have for consequence an increase of trade flows in this part of the world. if USA was divided in 51 federal states and China or India in provinces or states, it would necessarily increase their part of exchanges. 

We are therefore facing here a difficult question of Modifiable Area Unit Problem (MAUP) which can not be easily solved without deciding immediately to aggregate the data in larger units, more homogeneous,  where internal flows will be systematically removed. This will produce of course a strong reduction of the initial information but make possible to have a better analysis of the relation between the new territorial units. 


#### The 4 x3 =  12 basic territorial units


On the basis of expert advices, we have chosen 12 basic territorial units which are in fact associated to a first division of the world in 4 regions, each of them divided in 3 subregions. 

```{r}

gui2<-readRDS("data/Chelem_Reg_2.RDS") %>% filter(GUI2 !="G01")
gui2$code<-paste(gui2$GUI2,gui2$GUI2_Name)


mypal<-c(rev(brewer.pal(5,"Blues")[1:3]),
         rev(brewer.pal(5, "Reds")[1:3]),
        rev(brewer.pal(5,"YlOrBr")[1:3]),
         rev(brewer.pal(5,"Greens")[1:3])

         )
#mypal<-rainbow(12)
mf_theme("agolalight")
mf_map(gui2,
       type = "typo",
       var="code",
       leg_pos = "left",
       leg_title = "Régions",
       pal=mypal,
       )

mf_layout(title = "The 12 basic territorial units",
          credits = "Source : C. Grasland, 2024",
          frame = T,
          arrow = F
          )

```

The autors of this partition of the world suggest that the world economy has been (at least during a period of time) or could have been (whishfull thinking ?) be organized around three integrated "vertical macroregions" and one residual part of the word less integrated and submit to variable influence of the three vertical regions : 

- **G1 : Europe-Mediterranea-Africa** :  Clearly inherited from the history, this vertical region is based on various type of proximities including geographical distance, common sea (Mare Nostrum), common language, colonial legacy ... But what has been the destiny of these links over the last 50 years following the independancy of states from Africa ?
- **G2 : Americas** : Since the 19th century, *"the Monroe Doctrine is a United States foreign policy position that opposes European colonialism in the Western Hemisphere. It holds that any intervention in the political affairs of the Americas by foreign powers is a potentially hostile act against the United States"* (Wikipedia). This doctrine has been related to lot of conflict between the different parts of Americas but also associated to the building of various forms of cooperation like NAFTA (1994), MERCOSUR (1991), etc... In any case, the geographical proximity was clearly here in favor of a potential integration. But the reduction of transport cost in the 1980's has modified the role played by these factor in favor of trans-Pacific relationships. So, what is the situation of America's integration over our 50 years period of interest ?
- **G3 : Asia-Pacifica** : The economic integration of this part of the world is a long and complex process initially boosted by Japan and Korea, further by China and associated to a continuous process or development of free trade areas like ASEAN. This potential macro-region has been at the same time the pivot of global economic integration of the world, firstly with trans-pacific relation until 1990 and further with the rest of the world with the growing influence of China after this state joined the WTO in  2001. So, is it still a macroregion or the economic core of contemporary world ?

- **G4 : Rest of the World** : We can not speak here from an integrated economic region but rather as a group of states that (1) benefit from ressources of interest forthe rest of the world (e.g. oil and gas from the Gulf, mineral products from Russia, ...) and/or (2) develop a strategy of diversification of their exchange at world scale and refuse to be dependent from too powerful partners (e.g. strategy of India, Russia or Saudi Arabia). The question here is to what extent this part of the world remained "neutral" as compare to the three other ones or has been succesfully associated to the different other regions according to variable geometries.

All this remarks are hypothesis that suggest a possible way to cluster the 12 territorial units in 3 or four groups. But our aim is not here to validate the partition $(G_1,G_2,G_3,G_4)$ but rather to use it at starting point for the discovery of alternative geometries changing throug time or presenting variable configurations according to the type of products considered. 


#### 9 groups of goods

The authors of the database CHELEM as made incredible efforts to maintain an homogeneous categorisation of goods in 72 types of producst over a period of 50 years. Considering the changes of the world economy and the evolution of the nomenclature used by trade organization, it is a genuine miracle to have done such a work. We adopt here a simplified version of the CHELEM typology in only 9 groups of products that reflect the distribution of value chains as well as the international division of labor  (@grasland2010, @grataloup2014)

- (1) ENE : Energy
- (2) MIN : Minerals, Intermediate goods
- (3) AGR : Agriculture, Food
- (4) TEX : Textile, Clothing
- (5) ELE : Electronic
- (6) EQU : Equipment, Machines
- (7) TRA : Transport
- (8) CHE : Chemical products
- (9) MIS : Others



```{r}
Fkt<-dt[k!="TOT",.(Fkt=sum(Fijkt)),.(k,t)]
Ft<-dt[k!="TOT",.(Ft=sum(Fijkt)),.(t)]
tab<-left_join(Fkt,Ft) %>% mutate(pct=100*Fkt/Ft)
g<-ggplot(tab) + aes(x=t, y=pct,fill=k) +
               geom_bar(stat="identity") +
       scale_x_continuous("Année") +
       scale_y_continuous("% flux mondiaux") +
       ggtitle("Typology of trade goods in 9 groups",subtitle = "Source : CEPII, Base CHELEM")
ggplotly(g)
```

- **Commentaires** : A statistical interest of this typology (out of the fact that it is relevant in terms of divsion of labor) is that the groups are relatively equlibrated in size. They offer interesting trends of variation of their respective shares that can increase (electronic, chemical), decrease (agriculture) or present chaotic evolution related to the variations of price (energy)

#### The hypercube with its 5940 cells

```{r, eval=FALSE}
# This program build the hypercube

dt2<-dt %>% mutate(t=as.numeric(t)) %>%filter(t>1970)
dt2$t<-cut(dt2$t,breaks=c(1970, 1980,1990, 2000, 2010, 2020 ))
table(dt2$t)
levels(dt2$t)<-c("1971-80","1981-90","1991-00","2001-10","2011-20")
hc<-dt2[, .(Fijkt = sum(Fijkt)), .(Gi=reg1i, i=reg2i, Gj=reg1j, j=reg2j, k,t)]
hc<-hc %>% filter(i !=j, k!="TOT")
hc2<-hc %>% group_by(t) %>% mutate(Fijkt=Fijkt*1000000/sum(Fijkt)) %>% select(i,j,k,t,Fijkt)
hc3<-hc2 %>% select(i,j,k,t,Fijkt)
names(hc3)<-c("j","i","k","t","Fjikt")
hc4<-left_join(hc2,hc3) %>% arrange(i,j,k,t) %>% mutate(Vijkt=(Fijkt+Fjikt)/2, Bijkt=Fijkt-Fjikt)
hc4<-data.frame(hc4)
saveRDS(hc4,"data/MYCHELEM_Hypercube.RDS")
```

On the basis of previous rules we have built the expected hypercube with 5940 cells. The flows has been normalized to an arbitrary total sum of 1000000 for each period of ten years and the values has been round with zero decimal. We have introduced for each couple of region the flows in both direction $F_{ijkt}$ and $F_{jikt}$ in order to be able to compute easily the symetric part of exchange called volume and the asymetric part called balance :

- Volume : $V_{ijkt} = \frac{(F_{ijkt}+F_{jikt})}{2}$
- Balance : $B_{ijkt} = F_{ijkt}-F_{jikt}$


```{r}
hc<-readRDS("data/MYCHELEM_Hypercube.RDS")
kable(head(hc,10), digits=0)
```
 
 
### II. TESTING A PROPOSAL OF REGIONALISATION 

Before to adress the problem of research of an unknown partition, we will discuss the question of measuring the accuracy of an existing partition, which will help us to precise the problem of the choice of an optimisation criteria.

We will take as example the bilateral trade flows ($V_ijkt$) in order to have the same partition for origins and destination (the problem of asymmetry will be discussed later) and consider the total sum of flows in 1991-2000 as starting example. The existing partition will be the division in 4 regions (3 verticales + 1 residual).


#### Matrix of flows

```{r}
hc<-data.table(hc)
sel<-hc[t=="1991-00",.(Vij=sum(Vijkt)),.(i,j)]
sel$i<-substr(sel$i,1,3)
sel$j<-substr(sel$j,1,3)
tab<-dcast(sel,formula="i~j")
mat<-as.matrix(tab[,-1])
row.names(mat)<-tab$i
diag(mat)<-0
kable(addmargins(mat), captions="Matrix of bilateral flows 1991-2000", digits=0)
```

#### MOD0 : Double constraint model

Assuming that flows are made of 1000000 of discrete events (the total sum of the matrix) we choose as reference (null model) a situation where the export $O_i$ and import $D_j$  of each spatial unit is known (margins of the matrix) and where the exchange are randomly distributed. Because of the absence of information on the diagonal of the matrix (trade internal to each region), the model can not be solved by a simple estimation but desserve an iterative double constraint model taking the from

$F_{ij}^* = a_i.O_i.b_j.D_j+\epsilon_{ij}$


```{r}
sel$Vij<-round(sel$Vij,0)
mod0<-glm(data=sel,formula = "Vij~i+j", family="poisson")
anova(mod0,test="LRT")
paste("Mc Fadden Pseudo R-square =",round(1-(mod0$deviance/mod0$null.deviance),3))

```

This first model account for 87% of the initial deviance of the model which is important but logical considering the inequal size of the territorial units in terms of trade volume.

The analysis of standardized residual make possible to visualize the couple of units where exchanges are higher or lower than expected. A classification of this matrix of residuals make possible to reveal a structure in "blocks" of units that has more internal exchanges than expected. 

```{r}
sel$mod0_EST<-mod0$fitted.values
sel$mod0_RES<-mod0$residuals

tabres<-dcast(data=sel,formula = i~j, value.var = "mod0_RES")
matres<-as.matrix(tabres[,-1])
row.names(matres)<-tabres$i

pheatmap(mat=matres,
         main = "Classification of residuals",
         display_numbers = TRUE,
         fontsize = 8, 
         cluster_cols = TRUE,
         cutree_cols = 4,
         cluster_rows = TRUE,
         cutree_rows=4) 
```

We notice here that the classification of residuals fit relatively nicely with the expectations of the experts as we can recognize on the diagonal two first groups corresponding to the region Asia-Pacifica $(G_{31},G_{32}, G_{33})$ and the region Americas $(G_{21},G_{22}, G_{23})$. But the next region is limited to only two members of the Rest of the world $(G_{43},G_{43})$ because Russia $(G41)$ seems to be more associated with the region Europe-Mediterranea-Africa $(G_{11},G_{12}, G_{13})$. 


#### MOD1 : Regional model with a single parameter

We can try to build a first regional model that assume the existence of a simple preference effect with the same value $\gamma$ for units located inside the same region:

$F_{ij}^* = a_i.O_i.b_j.D_j.\gamma^{REG}+\epsilon_{ij}$

Despite the analysis made on the residuals, we decide to keep the partition in 4 regions forecast by the experts.

```{r}
sel$REG<-substr(sel$i,1,2)==substr(sel$j,1,2)
mod1<-glm(data=sel,formula = "Vij~i+j+REG", family="poisson")
anova(mod1,test="LRT")
paste("Mc Fadden Pseudo R-square (Total) =",round(1-(mod1$deviance/mod1$null.deviance),3))
anova(mod0,mod1,test="LRT")
paste("Mc Fadden Pseudo R-square (Gain) =",round(1-(mod1$deviance/mod0$deviance),3))
#paste("Gamma = ", round(exp(mod1$coefficients[24]),3))
```

We obtain a model with a pseudo R-square equal to 95 % of deviance explianed (including the effect of the null model) or 59 % of residual deviance of the reference model (excluding therefore what has been yet explained by double constraint on origins and estination). The coefficient $\gamma$ is very significant and equal to 3.02 which means that exchanges between units located in the same region are in average 3 times greater than exchanges between units located in different regions. 


#### MOD3 : Regional model with variable integration levels

We can adopt a different perspective and imagine that they are as many value of the parameter $\gamma_{k}$ as they are possibilities of belonging to the same regions. Our model wil therefore take the form

$F_{ij}^* = a_i.O_i.b_j.D_j.\gamma_{k}^{REG_{k}}+\epsilon_{ij}$

```{r}
sel$REG1<-substr(sel$i,1,2)=="G1" & substr(sel$j,1,2)=="G1"
sel$REG2<-substr(sel$i,1,2)=="G2" & substr(sel$j,1,2)=="G2"
sel$REG3<-substr(sel$i,1,2)=="G3" & substr(sel$j,1,2)=="G3"
sel$REG4<-substr(sel$i,1,2)=="G4" & substr(sel$j,1,2)=="G4"

mod2<-glm(data=sel,formula = "Vij~i+j+REG1+REG2+REG3+REG4", family="poisson")
#summary(mod2)
anova(mod2,test="LRT")
paste("Mc Fadden Pseudo R-square (Total) =",round(1-(mod2$deviance/mod1$null.deviance),3))
anova(mod0,mod1,mod2,test="LRT")
paste("Mc Fadden Pseudo R-square (Gain) =",round(1-(mod2$deviance/mod0$deviance),3))
#paste("Gamma1 = ", round(exp(mod2$coefficients[24]),3))
#paste("Gamma2 = ", round(exp(mod2$coefficients[25]),3))
#paste("Gamma3 = ", round(exp(mod2$coefficients[26]),3))
#paste("Gamma4 = ", round(exp(mod2$coefficients[27]),3))
```

This model acount know for 95.1 % of the total deviance and 62.1% of the residual deviance of the reference model. It offers a significant improvement of the previous model and reveal that the levels of integration are different in each region. The most integrated regions are Europe_Mediterranea_Africa ($\gamma_1=3.72$) and Americas ($\gamma_2=3.84$),followed by Asia-Pacifica ($\gamma_3=2.45$) and finally the rest of the world ($\gamma_4=1.36$)


#### MOD3 : Moving Russia toward Europe-Mediterranean-African region

In the previous analysis we have followed the expert advice concerning the division of the world in 4 regions. But we can ask if these choice was really optimal. Looking at the residual of the reference model, we can imagine another partition of the world in four groups where Russia is associated to the region Europe-Mediterranea-Asia. What would be the result ?

```{r}
sel2<-sel
sel2$i[sel2$i=="G41"]<-"G14"
sel2$j[sel2$j=="G41"]<-"G14"
sel2$REG1<-substr(sel2$i,1,2)=="G1" & substr(sel2$j,1,2)=="G1"
sel2$REG2<-substr(sel2$i,1,2)=="G2" & substr(sel2$j,1,2)=="G2"
sel2$REG3<-substr(sel2$i,1,2)=="G3" & substr(sel2$j,1,2)=="G3"
sel2$REG4<-substr(sel2$i,1,2)=="G4" & substr(sel2$j,1,2)=="G4"

mod3<-glm(data=sel2,formula = "Vij~i+j+REG1+REG2+REG3+REG4", family="poisson")
#summary(mod3)
anova(mod3,test="LRT")
paste("Mc Fadden Pseudo R-square (Total) =",round(1-(mod3$deviance/mod1$null.deviance),3))
anova(mod0,mod1,mod2,mod3,test="LRT")
paste("Mc Fadden Pseudo R-square (Gain) =",round(1-(mod3$deviance/mod0$deviance),3))
#paste("Gamma1 = ", round(exp(mod3$coefficients[24]),3))
#paste("Gamma2 = ", round(exp(mod3$coefficients[25]),3))
#paste("Gamma3 = ", round(exp(mod3$coefficients[26]),3))
#paste("Gamma4 = ", round(exp(mod3$coefficients[27]),3))
```

This model acount now for 96.9 % of the total deviance and 76.1% of the residual deviance of the reference model. It offers a significant improvement of the previous model and modify the levels of integration each region. The integration of the  Europe_Mediterranea_Africa extende to Russia is increased ($\gamma_1=4.74$) but a small decrease is observed in Americas ($\gamma_2=3.54$), in Asia-Pacifica ($\gamma_3=2.24$) but we observe a strong decrease of integration in the remaining part of the rest of the world ($\gamma_4=3.1$).



#### MOD2(t) : The time dimension

We decide know to replicate the model 2 for each of thetime period in order to examine the variations of regional integration.

```{r}
dt<-readRDS("data/MYCHELEM_Hypercube.RDS")
dt$Vijkt<-round(dt$Vijkt,0)
sel<-dt
sel$REG1<-substr(sel$i,1,2)=="G1" & substr(sel$j,1,2)=="G1"
sel$REG2<-substr(sel$i,1,2)=="G2" & substr(sel$j,1,2)=="G2"
sel$REG3<-substr(sel$i,1,2)=="G3" & substr(sel$j,1,2)=="G3"
sel$REG4<-substr(sel$i,1,2)=="G4" & substr(sel$j,1,2)=="G4"

mod_t<-glm(data=sel,formula = "Vijkt~i:t+j:t+REG1:t+REG2:t+REG3:t+REG4:t", family="poisson")
#summary(mod3)
anova(mod_t,test="LRT")
x<-mod_t$coefficients[117:136]
gamma<-exp(x)
t<-substr(names(x),2,8)
reg<-substr(names(x),10,13)
res<-data.frame(reg,t,gamma)
res2<-dcast(res, formula = reg~t, value.var="gamma")
res2<-as.data.frame(res2)
 row.names(res2) <- c("Eur-Med-Afr","Americas","Asia-Pacifica","Rest of the World")
kable(res2, digits=2,caption = "Parameters (gamma) of regional integration by time period")
```

_ **Commentaire** : The introduction of time reveals variations of regional integration through time. For example, the region Eur-Med-Afr has a maximum integration in 1981-1990 and 1990-2000 but lower level before and after. The region Americas, on the contrary has a maximum integration in the final periods of 2001-2010 and 2011-2020. The region Asia-Pacifica was very integrated in 1971-80 and experiment a decrease until 1991-2000 before to increase slowly again. 



#### MOD2(k) : The product dimension

Here, we replicate the model 2  but we examine separately the level of integration by products.

```{r}
dt<-readRDS("data/MYCHELEM_Hypercube.RDS")
dt$Vijkt<-round(dt$Vijkt,0)
sel<-dt %>% filter(t=="1991-00")
sel$REG1<-substr(sel$i,1,2)=="G1" & substr(sel$j,1,2)=="G1"
sel$REG2<-substr(sel$i,1,2)=="G2" & substr(sel$j,1,2)=="G2"
sel$REG3<-substr(sel$i,1,2)=="G3" & substr(sel$j,1,2)=="G3"
sel$REG4<-substr(sel$i,1,2)=="G4" & substr(sel$j,1,2)=="G4"

mod_k<-glm(data=sel,formula = "Vijkt~i:k+j:k+REG1:k+REG2:k+REG3:k+REG4:k", family="poisson")
#summary(mod3)
anova(mod_k,test="LRT")

x<-mod_k$coefficients[209:244]
gamma<-exp(x)
k<-substr(names(x),6,8)
reg<-substr(names(x),10,13)
res<-data.frame(reg,k,gamma)
res2<-dcast(res, formula = reg~k, value.var="gamma")
res2<-as.data.frame(res2)
 row.names(res2) <- c("Eur-Med-Afr","Americas","Asia-Pacifica","Rest of the World")
kable(res2, digits=2,caption = "Parameters (gamma) of regional integration by products in 2011-2020 ")
```

- **Commentaire** : The table reveals very important differences in the degree of regional integration of trade within the same region when we consider different products. For example the region America is very strongly integrated for energy ($\gamma = 16.8$) because of its relative autonomy for the provision of gas, oil or coal. It is less integrated for Agriculture and food ($\gamma = 1.7$) because of high level of exports and imports with the rest of the world.





#### Discussion : what is the best regionalization ?

The sequence of models indicates that a simple validation of an existing partition does not guarantee that we have found the optimal solution. In our example, we should certainly explore all the possible partition before to validate our final model as the best partition of world trade in 4 regions. 

We have also to consider that the decision fo choose 4 regions is not necessarily optimal and we could imagine that more interestin results could be achieved with a partition in 2, 3 or 5 regions. But in this case we have to propose a criterium of optimisation like AIC or BIC which take into account the number of classes used. 
Finally our results sggest:

1. the optimal partition in 1991-2000 is not necessarily the best at another time period. 
2. The optimal partition for one type of goods is not necessarily the same for another type of goods. 

In other words, the question of optimal regionalisation is very complex but also very exciting ...

### III. MULTIDIMENSIONAL SCALING

We propose here a different approach of the problem of regionalisation using a **inverse gravity model** for the extraction of *trade distances* and  **multidimensional scaling** for the realisation of a *map of relative position* of world regions in a bi-dimensional space.


#### Evaluation of trade distances by inverse gravity model

We start again from the matrix of trade flows between the 12 world subregions described in the previous part of the analysis.

```{r}
hc<-readRDS("data/MYCHELEM_Hypercube.RDS")
hc<-data.table(hc)
sel<-hc[t=="1991-00",.(Vij=sum(Vijkt)),.(i,j)]
sel$i<-substr(sel$i,1,3)
sel$j<-substr(sel$j,1,3)
tab<-dcast(sel,formula="i~j")
mat<-as.matrix(tab[,-1])
row.names(mat)<-tab$i
diag(mat)<-0
kable(addmargins(mat), captions="Matrix of bilateral flows 1991-2000", digits=0)
```
We assume the existence of an unknown *trade distance* $D_{ij}$ which summarize tha various factor explains why the observed flows $F_{ij}$ are not equal to the ones estimated by our double contraint random model $F^*_{ij}$. Therefore we have the equation :

$F_{ij} = \frac{a_i.O_i.b_j.D_j}{D^2_{ij}}+\epsilon_{ij} <=> D_{ij} = \sqrt{\frac{F_{ij}}{F^*_{ij}}}$

Usong the results of our random model we obtain the followig matrix of distance where we have adjust the distances to obtain a maximum of 20000 which is the maximum possible distance on the Earth between two  points.

```{r}
sel$Vij<-round(sel$Vij)
mod<-glm(formula = "Vij~i+j",family = "poisson",data=sel)
res<-mod$model
res$Eij<-mod$fitted.values
res$DSij<-res$Eij/res$Vij
#res$DSij[res$DSij>10]<-10
#hist(res$DSij)
z<-dcast(res,formula = i~j,value.var = "DSij",fill = 0) 
w<-dcast(res,formula = i~j,value.var = "Vij",fill = 0) 
m<-as.matrix(z[,-1])
row.names(m)<-colnames(m)
m<-sqrt(m)
m<-round(m*20000/max(m))

kable(m, captions="Trade distance associated to the matrix of bilateral flows 1991-2000", digits=2)
```

- **Comment** : The maximum distance (20000 km) is observed between SE Mediterraneean (G12) and Central America (G22). They are not the most distant unit geographically (approx. 12000 km between Le Caire and Mexico) but they are both strongly integrated with their neigbours (Europe for G12 and Northern America for G22) which certainly explains why they obtain the maximum distance in the matrix. The shortest distance  are generally observed between units located in the same region like G11-G12 , G11-G13 , G21-G22, G31-G32 , G32-G33 (912km) or G42-43 . The only exception to this rule is the distance  between G13 (subsaharian Africa) and G43 (Australia-Oceania), but we have to keep in mind that both units are located in the Southern Hemisphere.

#### Visualisation by multidimensional scaling

We propose now to produce a "map" of the relative position of units by mean of a Multi Dimensional Scaling (MDS) method. We use here the smacof program in the simplest version for a first approach :

```{r}
library(smacof)
library(ggrepel)
res<-mds(m,ndim = 2,weightmat=m, type="ordinal")
#plot(res)
df<-as.data.frame(res$conf)
df$lab<-row.names(res$conf)
df$region<-as.factor(substr(df$lab,1,2))
levels(df$region)<-c("Eur-Med_Afr","Americas","Asia-Pacifica","Rest of World")
ggplot(df,aes(x=D1,y=-D2,label=lab,color=region))+
  geom_point()+
  geom_text_repel()+
  coord_fixed(ratio=1)+
  theme_minimal()


```

#### Replication in 2011-2020


```{r}
sel<-hc[t=="2011-20",.(Vij=sum(Vijkt)),.(i,j)]
sel$i<-substr(sel$i,1,3)
sel$j<-substr(sel$j,1,3)
tab<-dcast(sel,formula="i~j")
mat<-as.matrix(tab[,-1])
row.names(mat)<-tab$i
diag(mat)<-0

sel$Vij<-round(sel$Vij)
mod<-glm(formula = "Vij~i+j",family = "poisson",data=sel)
res<-mod$model
res$Eij<-mod$fitted.values
res$DSij<-res$Eij/res$Vij
#res$DSij[res$DSij>10]<-10
#hist(res$DSij)
z<-dcast(res,formula = i~j,value.var = "DSij",fill = 0) 
w<-dcast(res,formula = i~j,value.var = "Vij",fill = 0) 
m<-as.matrix(z[,-1])
row.names(m)<-colnames(m)
m<-sqrt(m)
m<-round(m*20000/max(m))

res<-mds(m,ndim = 2,weightmat=m)
#res<-mds(m,ndim = 2,weightmat=m, type="ordinal")
#plot(res)
df<-as.data.frame(res$conf)
df$lab<-row.names(res$conf)
df$region<-as.factor(substr(df$lab,1,2))
levels(df$region)<-c("Eur-Med_Afr","Americas","Asia-Pacifica","Rest of World")
ggplot(df,aes(x=D1,y=-D2,label=lab,color=region))+
  geom_point()+
  geom_text_repel()+
  coord_fixed(ratio=1)+
  theme_minimal()
```



